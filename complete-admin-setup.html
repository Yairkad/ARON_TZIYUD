<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Admin Setup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .step {
            background: #f9f9f9;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .step h2 {
            margin-top: 0;
            color: #667eea;
            font-size: 18px;
        }
        button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196F3;
        }
        .success {
            background: #c8e6c9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: #ffcdd2;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            text-align: left;
            direction: ltr;
            font-size: 12px;
        }
        .user-card {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px;
        }
        .status-complete {
            background: #c8e6c9;
            color: #2e7d32;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .login-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .login-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ×”×’×“×¨×ª Super Admin - ×ª×”×œ×™×š ××œ×</h1>

        <div class="step">
            <h2>ğŸ“‹ ×©×œ×‘ 1: ×‘×“×™×§×ª ××¦×‘ × ×•×›×—×™</h2>
            <button class="btn-primary" onclick="checkCurrentState()">×‘×“×•×§ ××¦×‘ ××©×ª××©×™×</button>
            <div id="checkResult"></div>
        </div>

        <div class="step">
            <h2>ğŸ—‘ï¸ ×©×œ×‘ 2: × ×™×§×•×™ ××©×ª××©×™× ×§×™×™××™×</h2>
            <p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 5px;">
                âš ï¸ ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”××©×ª××©×™× ×”×§×™×™××™× (×›×•×œ×œ ××©×ª××©×™× "×ª×§×•×¢×™×")
            </p>
            <button class="btn-danger" onclick="deleteAllUsers()">××—×§ ××ª ×›×œ ×”××©×ª××©×™×</button>
            <div id="deleteResult"></div>
        </div>

        <div class="step">
            <h2>âœ¨ ×©×œ×‘ 3: ×™×¦×™×¨×ª Super Admin ×—×“×©</h2>
            <p style="background: #e3f2fd; padding: 10px; border-radius: 5px;">
                <strong>×¤×¨×˜×™ ×”××©×ª××© ×©×™×™×•×•×¦×¨:</strong><br>
                ğŸ“§ Email: yk74re@gmail.com<br>
                ğŸ”‘ Password: Admin2025<br>
                ğŸ‘‘ Role: super_admin<br>
                âœ… Permissions: full_access
            </p>
            <button class="btn-success" onclick="createSuperAdmin()">×¦×•×¨ Super Admin</button>
            <div id="createResult"></div>
        </div>

        <div class="step">
            <h2>ğŸ” ×©×œ×‘ 4: ××™××•×ª ×•×”×ª×—×‘×¨×•×ª</h2>
            <button class="btn-primary" onclick="verifyUser()">×××ª ×©×”××©×ª××© × ×•×¦×¨</button>
            <div id="verifyResult"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://jgkmcsxrtovrdiguhwyv.supabase.co';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impna21jc3hydG92cmRpZ3Vod3l2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjEwNzExMiwiZXhwIjoyMDc3NjgzMTEyfQ.yTAJKE4koX56lJ8ZA0utYf9x2Ytj_mLHwIOzt-xpYxY';

        async function checkCurrentState() {
            const resultDiv = document.getElementById('checkResult');
            resultDiv.innerHTML = '<div class="result info">ğŸ”„ ×‘×•×“×§ ××¦×‘ × ×•×›×—×™...</div>';

            try {
                // Check auth.users via Admin API
                const authResponse = await fetch(`${SUPABASE_URL}/auth/v1/admin/users`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                        'apikey': SUPABASE_SERVICE_KEY
                    }
                });

                let html = '<div class="result info">';

                if (authResponse.ok) {
                    const authData = await authResponse.json();
                    const authUsers = authData.users || [];

                    html += `<h3>ğŸ“Š ×¡×˜×˜×•×¡ ××¢×¨×›×ª</h3>`;
                    html += `<p><strong>××©×ª××©×™× ×‘-auth.users:</strong> ${authUsers.length}</p>`;

                    if (authUsers.length > 0) {
                        html += '<h4>××©×ª××©×™× × ×•×›×—×™×™×:</h4>';
                        authUsers.forEach(user => {
                            html += `<div class="user-card">`;
                            html += `<strong>ğŸ“§ Email:</strong> ${user.email}<br>`;
                            html += `<strong>ğŸ†” ID:</strong> <code style="font-size: 10px">${user.id}</code><br>`;
                            html += `<strong>ğŸ“… × ×•×¦×¨:</strong> ${new Date(user.created_at).toLocaleString('he-IL')}<br>`;
                            html += `<strong>âœ… ×××•××ª:</strong> ${user.email_confirmed_at ? '×›×Ÿ' : '×œ×'}`;
                            html += `</div>`;
                        });
                        html += '<div class="warning" style="margin-top: 10px;">âš ï¸ ×™×© ×¦×•×¨×š ×œ××—×•×§ ××©×ª××©×™× ××œ×” ×œ×¤× ×™ ×™×¦×™×¨×ª ××©×ª××© ×—×“×©</div>';
                    } else {
                        html += '<div class="success" style="margin-top: 10px;">âœ… ××™×Ÿ ××©×ª××©×™× - ××•×›×Ÿ ×œ×™×¦×™×¨×ª Super Admin</div>';
                    }
                } else {
                    const errorData = await authResponse.json();
                    html += `<div class="error">âŒ ×©×’×™××” ×‘×‘×“×™×§×ª auth.users: ${JSON.stringify(errorData)}</div>`;
                }

                html += '</div>';
                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ ×©×’×™××”: ${error.message}</div>`;
            }
        }

        async function deleteAllUsers() {
            if (!confirm('âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”××©×ª××©×™×?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ×’× ××©×ª××©×™× "×ª×§×•×¢×™×" ×©×œ× × ×™×ª×Ÿ ×œ××—×•×§ ×“×¨×š ×”×××©×§.\n\n×–×• ×¤×¢×•×œ×” ×‘×œ×ª×™ ×”×¤×™×›×”!')) {
                return;
            }

            const resultDiv = document.getElementById('deleteResult');
            resultDiv.innerHTML = '<div class="result info">ğŸ”„ ××•×—×§ ××©×ª××©×™×...</div>';

            try {
                // Get all users
                const authResponse = await fetch(`${SUPABASE_URL}/auth/v1/admin/users`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                        'apikey': SUPABASE_SERVICE_KEY
                    }
                });

                if (!authResponse.ok) {
                    throw new Error('Failed to fetch users');
                }

                const authData = await authResponse.json();
                const users = authData.users || [];

                if (users.length === 0) {
                    resultDiv.innerHTML = '<div class="result info">â„¹ï¸ ××™×Ÿ ××©×ª××©×™× ×œ××—×™×§×”</div>';
                    return;
                }

                let deleted = 0;
                let failed = 0;
                let errors = [];

                // Delete each user
                for (const user of users) {
                    try {
                        const deleteResponse = await fetch(`${SUPABASE_URL}/auth/v1/admin/users/${user.id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                                'apikey': SUPABASE_SERVICE_KEY
                            }
                        });

                        if (deleteResponse.ok || deleteResponse.status === 204) {
                            deleted++;
                            console.log(`âœ… Deleted user: ${user.email}`);
                        } else {
                            failed++;
                            const errorText = await deleteResponse.text();
                            errors.push(`${user.email}: ${errorText}`);
                            console.error(`âŒ Failed to delete user: ${user.email}`, errorText);
                        }
                    } catch (err) {
                        failed++;
                        errors.push(`${user.email}: ${err.message}`);
                        console.error(`âŒ Error deleting user: ${user.email}`, err);
                    }
                }

                let html = '<div class="result ';
                html += failed === 0 ? 'success' : 'warning';
                html += '">';
                html += '<h3>ğŸ“Š ×ª×•×¦××•×ª ××—×™×§×”</h3>';
                html += `<p>âœ… × ××—×§×• ×‘×”×¦×œ×—×”: ${deleted} ××©×ª××©×™×</p>`;
                if (failed > 0) {
                    html += `<p>âŒ × ×›×©×œ×•: ${failed} ××©×ª××©×™×</p>`;
                    html += '<details><summary>×¤×¨×˜×™ ×©×’×™××•×ª</summary><pre>' + errors.join('\n') + '</pre></details>';
                }
                html += '<p style="margin-top: 15px;">â¡ï¸ ×›×¢×ª × ×™×ª×Ÿ ×œ×¢×‘×•×¨ ×œ×©×œ×‘ 3 ×•×œ×™×¦×•×¨ Super Admin ×—×“×©</p>';
                html += '</div>';

                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ ×©×’×™××”: ${error.message}</div>`;
            }
        }

        async function createSuperAdmin() {
            const resultDiv = document.getElementById('createResult');
            resultDiv.innerHTML = '<div class="result info">ğŸ”„ ×™×•×¦×¨ Super Admin...</div>';

            try {
                console.log('Creating Super Admin with Supabase Auth API...');

                const response = await fetch(`${SUPABASE_URL}/auth/v1/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                        'apikey': SUPABASE_SERVICE_KEY
                    },
                    body: JSON.stringify({
                        email: 'yk74re@gmail.com',
                        password: 'Admin2025',
                        email_confirm: true,
                        user_metadata: {
                            full_name: 'Super Admin',
                            role: 'super_admin',
                            permissions: 'full_access'
                        }
                    })
                });

                const data = await response.json();

                if (response.ok && data.id) {
                    console.log('âœ… User created successfully:', data);

                    // Wait for trigger to create public.users entry
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    let html = '<div class="result success">';
                    html += '<h3>âœ… Super Admin × ×•×¦×¨ ×‘×”×¦×œ×—×”!</h3>';
                    html += `<p><strong>ğŸ†” User ID:</strong> <code style="font-size: 10px">${data.id}</code></p>`;
                    html += `<p><strong>ğŸ“§ Email:</strong> ${data.email}</p>`;
                    html += '<hr style="margin: 20px 0;">';
                    html += '<h4>ğŸ” ×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª:</h4>';
                    html += '<p><strong>Email:</strong> yk74re@gmail.com</p>';
                    html += '<p><strong>Password:</strong> Admin2025</p>';
                    html += '<a href="https://aron-tziyud.vercel.app/super-admin" target="_blank" class="login-link">ğŸŒ ×”×ª×—×‘×¨ ×¢×›×©×™×•</a>';
                    html += '<p style="margin-top: 15px; color: #666;">â¡ï¸ ×¢×‘×•×¨ ×œ×©×œ×‘ 4 ×›×“×™ ×œ×××ª ×©×”××©×ª××© × ×•×¦×¨ ×‘×©×ª×™ ×”×˜×‘×œ××•×ª</p>';
                    html += '</div>';

                    resultDiv.innerHTML = html;
                } else {
                    console.error('âŒ Failed to create user:', data);
                    resultDiv.innerHTML = `<div class="result error">
                        <h3>âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ××©×ª××©</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                }
            } catch (error) {
                console.error('âŒ Error:', error);
                resultDiv.innerHTML = `<div class="result error">
                    <h3>âŒ ×©×’×™××”</h3>
                    <p>${error.message}</p>
                </div>`;
            }
        }

        async function verifyUser() {
            const resultDiv = document.getElementById('verifyResult');
            resultDiv.innerHTML = '<div class="result info">ğŸ”„ ××××ª ××©×ª××©...</div>';

            try {
                // Check auth.users
                const authResponse = await fetch(`${SUPABASE_URL}/auth/v1/admin/users`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                        'apikey': SUPABASE_SERVICE_KEY
                    }
                });

                const authData = await authResponse.json();
                const authUser = authData.users?.find(u => u.email === 'yk74re@gmail.com');

                // Check public.users
                const publicResponse = await fetch(`${SUPABASE_URL}/rest/v1/users?email=eq.yk74re@gmail.com&select=*`, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                        'apikey': SUPABASE_SERVICE_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                const publicData = await publicResponse.json();
                const publicUser = Array.isArray(publicData) && publicData.length > 0 ? publicData[0] : null;

                let html = '<div class="result ';
                html += (authUser && publicUser) ? 'success' : 'error';
                html += '">';

                html += '<h3>ğŸ” ×ª×•×¦××•×ª ××™××•×ª</h3>';

                html += '<div style="margin: 15px 0;">';
                html += '<strong>auth.users:</strong> ';
                if (authUser) {
                    html += '<span class="status-badge status-complete">âœ… ×§×™×™×</span>';
                    html += `<div class="user-card" style="margin-top: 10px;">`;
                    html += `<strong>ID:</strong> <code style="font-size: 10px">${authUser.id}</code><br>`;
                    html += `<strong>Email:</strong> ${authUser.email}<br>`;
                    html += `<strong>×××•××ª:</strong> ${authUser.email_confirmed_at ? '×›×Ÿ âœ…' : '×œ× âŒ'}`;
                    html += `</div>`;
                } else {
                    html += '<span class="status-badge status-pending">âŒ ×œ× ×§×™×™×</span>';
                }
                html += '</div>';

                html += '<div style="margin: 15px 0;">';
                html += '<strong>public.users:</strong> ';
                if (publicUser) {
                    html += '<span class="status-badge status-complete">âœ… ×§×™×™×</span>';
                    html += `<div class="user-card" style="margin-top: 10px;">`;
                    html += `<strong>Role:</strong> ${publicUser.role}<br>`;
                    html += `<strong>Permissions:</strong> ${publicUser.permissions}<br>`;
                    html += `<strong>Active:</strong> ${publicUser.is_active ? '×›×Ÿ âœ…' : '×œ× âŒ'}<br>`;
                    html += `<strong>Full Name:</strong> ${publicUser.full_name}`;
                    html += `</div>`;
                } else {
                    html += '<span class="status-badge status-pending">âŒ ×œ× ×§×™×™×</span>';
                    html += '<p style="margin-top: 10px; color: #c62828;">âš ï¸ ×”××©×ª××© ×œ× × ×•×¦×¨ ×‘-public.users - ×‘×¢×™×” ×‘-Trigger!</p>';
                }
                html += '</div>';

                if (authUser && publicUser) {
                    html += '<hr style="margin: 20px 0;">';
                    html += '<h3 style="color: #2e7d32;">ğŸ‰ ×”×›×œ ××•×›×Ÿ!</h3>';
                    html += '<p>×”××©×ª××© × ×•×¦×¨ ×‘×”×¦×œ×—×” ×‘×©×ª×™ ×”×˜×‘×œ××•×ª</p>';
                    html += '<a href="https://aron-tziyud.vercel.app/super-admin" target="_blank" class="login-link">ğŸŒ ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª</a>';
                } else if (authUser && !publicUser) {
                    html += '<hr style="margin: 20px 0;">';
                    html += '<div class="warning" style="padding: 15px;">';
                    html += '<h4>âš ï¸ × ×“×¨×©×ª ×ª×™×§×•×Ÿ ×™×“× ×™</h4>';
                    html += '<p>×”××©×ª××© × ×•×¦×¨ ×‘-auth.users ××‘×œ ×œ× ×‘-public.users</p>';
                    html += '<p>×”×‘×¢×™×” ×”×™× ×‘-Trigger ×©×œ ×”××¡×“ × ×ª×•× ×™×</p>';
                    html += '<p><strong>×¤×ª×¨×•×Ÿ:</strong> ×™×© ×œ×”×¨×™×¥ ××ª fix-and-create-admin.sql ×‘-Supabase SQL Editor</p>';
                    html += '</div>';
                }

                html += '</div>';
                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ ×©×’×™××”: ${error.message}</div>`;
            }
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            setTimeout(checkCurrentState, 500);
        });
    </script>
</body>
</html>
