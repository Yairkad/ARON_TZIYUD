<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ארון ציוד ידידים</title>
  <style>
    :root {
      --blue: #2563eb;
      --light-blue: #e0f2fe;
      --orange: #fb923c;
      --bg: #f8fafc;
      --text: #1e293b;
    }
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: var(--blue);
      color: white;
      text-align: center;
      padding: 1rem;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 1rem;
    }
    h2 {
      color: var(--blue);
      border-bottom: 2px solid var(--light-blue);
      padding-bottom: 0.5rem;
    }
    input, select, button {
      width: 100%;
      padding: 0.7rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 0.75rem;
      font-size: 15px;
    }
    button {
      background: var(--blue);
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    button:hover { background: var(--orange); }
    .section {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    .hidden { display: none; }
    .lang-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      background: var(--orange);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-weight: bold;
    }
    @media(max-width:600px){
      h2 { font-size: 18px; }
      input, select, button { font-size: 14px; }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="pageTitle">ארון ציוד ידידים</h1>
  </header>

  <div class="container">
    <!-- ממשק משתמש רגיל -->
    <div class="section" id="userInterface">
      <h2>📦 השאלת ציוד</h2>
      <input id="borrowName" placeholder="שם מלא">
      <input id="borrowPhone" placeholder="טלפון">
      <select id="borrowItem"></select>
      <button onclick="borrowItem()">השאל</button>

      <h2>🔄 החזרת ציוד</h2>
      <input id="returnName" placeholder="שם מלא">
      <input id="returnPhone" placeholder="טלפון">
      <button onclick="searchReturn()">חפש פריטים להחזרה</button>
      <div id="returnList"></div>
    </div>

    <!-- כניסת מנהל -->
    <div class="section" id="loginSection">
      <h2>🔑 כניסת מנהל</h2>
      <input type="password" id="adminCode" placeholder="הכנס קוד מנהל">
      <button onclick="loginAdmin()">כניסה</button>
    </div>

    <!-- פאנל מנהל -->
    <div class="section hidden" id="adminPanel">
      <h2>📋 ניהול ציוד</h2>
      <div id="inventoryList"></div>

      <h3>➕ הוספת פריט חדש</h3>
      <input id="newItemName" placeholder="שם פריט">
      <input id="newItemQuantity" type="number" placeholder="כמות">
      <button onclick="addNewItem()">הוסף</button>

      <h3>🚪 התנתקות</h3>
      <button style="background:#ef4444" onclick="logout()">התנתק</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

window.borrowItem = borrowItem;
window.searchReturn = searchReturn;
window.loginAdmin = loginAdmin;
window.logout = logout;
window.addNewItem = addNewItem;
window.returnItem = returnItem;
window.deleteItem = deleteItem;

    
    const firebaseConfig = {
      apiKey: "AIzaSyCfZImZVSxkozGdQiwZLFOpChdEDjM2Tz8",
      authDomain: "aronyedidim.firebaseapp.com",
      databaseURL: "https://aronyedidim-default-rtdb.firebaseio.com",
      projectId: "aronyedidim",
      storageBucket: "aronyedidim.firebasestorage.app",
      messagingSenderId: "473887573965",
      appId: "1:473887573965:web:3f5fbed40fa4fc01b66684"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const ADMIN_PASSWORD = "1234"; // קוד מנהל קבוע

    const refs = {
      equipment: ref(db, "equipment"),
      history: ref(db, "borrowHistory")
    };

    // טען רשימת ציוד
    onValue(refs.equipment, (snapshot) => {
      const data = snapshot.val() || {};
      const select = document.getElementById("borrowItem");
      select.innerHTML = "";
      for (const id in data) {
        const item = data[id];
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = `${item.name} (${item.quantity})`;
        opt.disabled = item.quantity === 0;
        select.appendChild(opt);
      }
      renderInventory(data);
    });

    // כניסת מנהל
    window.loginAdmin = function() {
      const code = document.getElementById("adminCode").value.trim();
      if (code === ADMIN_PASSWORD) {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("adminPanel").classList.remove("hidden");
      } else {
        alert("קוד שגוי");
      }
    };

    // התנתקות
    window.logout = function() {
      document.getElementById("adminPanel").classList.add("hidden");
      document.getElementById("loginSection").classList.remove("hidden");
    };

    // השאלת פריט
    window.borrowItem = function() {
      const name = document.getElementById("borrowName").value.trim();
      const phone = document.getElementById("borrowPhone").value.trim();
      const itemId = document.getElementById("borrowItem").value;
      if (!name || !phone || !itemId) return alert("מלא את כל השדות");

      get(ref(db, "equipment/" + itemId)).then((snap) => {
        const item = snap.val();
        if (item.quantity > 0) {
          const newBorrow = push(refs.history));
          set(newBorrow, {
            name,
            phone,
            itemName: item.name,
            date: new Date().toLocaleString("he-IL"),
            status: "borrowed"
          });
          update(ref(db, "equipment/" + itemId), { quantity: item.quantity - 1 });
          alert("✅ הפריט נלקח בהצלחה!");
        } else alert("❌ אין מלאי לפריט זה.");
      });
    };

    // חיפוש להחזרה
    window.searchReturn = function() {
      const name = document.getElementById("returnName").value.trim();
      const phone = document.getElementById("returnPhone").value.trim();
      if (!name || !phone) return alert("מלא שם וטלפון");

      get(refs.history).then((snap) => {
        const data = snap.val() || {};
        const matches = Object.entries(data).filter(([id, v]) =>
          v.name === name && v.phone === phone && v.status === "borrowed"
        );
        const list = document.getElementById("returnList");
        list.innerHTML = "";
        if (matches.length === 0) return (list.innerHTML = "לא נמצאו פריטים להשבה.");
        matches.forEach(([id, v]) => {
          const div = document.createElement("div");
          div.innerHTML = `${v.itemName} <button onclick="returnItem('${id}', '${v.itemName}')">החזר</button>`;
          list.appendChild(div);
        });
      });
    };

    // החזרת פריט
    window.returnItem = function(id, itemName) {
      update(ref(db, "borrowHistory/" + id), { status: "returned" });
      onValue(refs.equipment, (snap) => {
        const data = snap.val();
        for (const key in data) {
          if (data[key].name === itemName) {
            update(ref(db, "equipment/" + key), { quantity: data[key].quantity + 1 });
          }
        }
      });
      alert("✅ הוחזר בהצלחה!");
    };

    // הוספת פריט חדש
    window.addNewItem = function() {
      const name = document.getElementById("newItemName").value.trim();
      const quantity = parseInt(document.getElementById("newItemQuantity").value);
      if (!name || quantity <= 0) return alert("מלא את כל השדות כראוי");
      const newRef = push(refs.equipment);
      set(newRef, { name, quantity });
      alert("✅ נוסף בהצלחה!");
    };

    // הצגת מלאי בפאנל מנהל
    function renderInventory(data) {
      const list = document.getElementById("inventoryList");
      list.innerHTML = "";
      for (const id in data) {
        const item = data[id];
        const div = document.createElement("div");
        div.innerHTML = `${item.name} (${item.quantity}) <button onclick="deleteItem('${id}')">🗑️</button>`;
        list.appendChild(div);
      }
    }

    // מחיקת פריט
    window.deleteItem = function(id) {
      if (confirm("למחוק את הפריט?")) {
        set(ref(db, "equipment/" + id), null);
        alert("✅ נמחק בהצלחה");
      }
    };
  </script>
</body>
</html>
